<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Callback</title>
  <link rel="icon"
        type="image/x-icon"
        href="favicon.png">
  <script src="oidc-client.min.js"
          type="application/javascript"></script>
</head>

<body>
  <script>
    var Oidc = window.Oidc;
    var isPopupCallback = false;

    var config = {
      userStore: new Oidc.WebStorageStateStore({ store: window.localStorage })
    }

    if ((Oidc && Oidc.Log && Oidc.Log.logger)) {
      Oidc.Log.logger = console;
    }

    // read state from callback fragment
    var stateId;
    var fragments = window.location.hash.split('&');
    for (i = 0; i < fragments.length; i++) {
      var stateIndex = fragments[i].indexOf('state=');
      if (stateIndex === 0) {
        stateId = fragments[i].substring(stateIndex + 'state='.length);
      }
    }

    // lookup state in store
    config.userStore.get(stateId).then(function (state) {
      state = JSON.parse(state);
      // either use popup
      if (state && state.data && state.data.ngOidcClient && state.data.ngOidcClient.isPopup) {
        console.log('signincallback popup');
        new Oidc.UserManager(config).signinPopupCallback();
      } else {
        // or redirect
        new Oidc.UserManager(config).signinRedirectCallback().then(t => {
          window.location.href = '/';
        });
      }
    }, function (error) {
      console.log(error);
      // hanlde error
    });
  </script>
</body>

</html>
